#!/bin/bash
# setup-ide-aliases - Generate aliases for IDE launchers

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Paths
ALIASES_FILE="$HOME/.zsh/ide-aliases.zsh"
ZSHRC_FILE="$HOME/.zshrc"
BIN_DIR="$HOME/.local/bin"

# Default alias suffixes
declare -A default_suffixes=(
    ["nvim-launcher"]="ai"
    ["cursor-launcher"]="dev"
    ["zed-launcher"]="edit"
    ["opencode-launcher"]="code"
    ["claude-code-launcher"]="claude"
    ["code-launcher"]="vscode"
)

generate_alias_name() {
    local launcher="$1"
    local base_name="${launcher%-launcher}"
    local suffix="${default_suffixes[$launcher]:-app}"
    echo "${base_name}-${suffix}"
}

create_aliases_file() {
    echo -e "${YELLOW}Creating $ALIASES_FILE...${NC}"
    mkdir -p "$(dirname "$ALIASES_FILE")"

    cat > "$ALIASES_FILE" << 'EOF'
# IDE Aliases - Generated by setup-ide-aliases.sh
# These aliases provide quick access to IDE launchers
# Use with or without API keys as needed

EOF

    local found=0
    for launcher in "$BIN_DIR"/*-launcher; do
        if [[ -x "$launcher" ]]; then
            local launcher_name
            launcher_name=$(basename "$launcher")
            local alias_name
            alias_name=$(generate_alias_name "$launcher_name")
            echo "alias ${alias_name}=\"$launcher\"" >> "$ALIASES_FILE"
            echo -e "${GREEN}‚úì Added alias: ${alias_name}${NC}"
            ((found++))
        fi
    done

    if [[ $found -eq 0 ]]; then
        echo -e "${YELLOW}No launcher scripts found in $BIN_DIR${NC}"
        echo -e "${YELLOW}Run 'stow scripts' and 'ide-chooser' first.${NC}"
        rm -f "$ALIASES_FILE"
        exit 1
    fi

    echo -e "${GREEN}‚úì Created $ALIASES_FILE with $found aliases${NC}"
}

ensure_sourced_in_zshrc() {
    local source_line="source $ALIASES_FILE"

    if ! grep -q "$source_line" "$ZSHRC_FILE" 2>/dev/null; then
        echo -e "${YELLOW}Adding source line to $ZSHRC_FILE...${NC}"
        echo "" >> "$ZSHRC_FILE"
        echo "# Load IDE aliases" >> "$ZSHRC_FILE"
        echo "$source_line" >> "$ZSHRC_FILE"
        echo -e "${GREEN}‚úì Added source line to $ZSHRC_FILE${NC}"
    else
        echo -e "${GREEN}‚úì Source line already in $ZSHRC_FILE${NC}"
    fi
}

main() {
    echo -e "${BLUE}üè∑Ô∏è  Setup IDE Aliases${NC}"
    echo -e "${BLUE}===================${NC}"
    echo ""

    if [[ ! -d "$BIN_DIR" ]]; then
        echo -e "${RED}Error: $BIN_DIR not found. Run 'stow scripts' first.${NC}"
        exit 1
    fi

    create_aliases_file
    ensure_sourced_in_zshrc

    echo ""
    echo -e "${GREEN}üéâ Aliases setup complete! Restart your shell or run 'source $ZSHRC_FILE'${NC}"
    echo -e "${YELLOW}Available aliases:${NC}"
    grep '^alias ' "$ALIASES_FILE" | sed 's/alias //' | while IFS= read -r line; do
        echo -e "  ${GREEN}$line${NC}"
    done
}

main "$@"